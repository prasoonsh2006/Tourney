<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Admin Control Panel</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            top: 20px;
            width: 100vw;
            font-family: "Poppins", sans-serif;
            color: #e0e0e0; /* Adjusted for better contrast on lighter backgrounds */
            min-height: 100vh;

            /* Background Image with Dark Overlay */
            background-image: url('images/carbg3.jpg');
            background-color: var(--color-dark-grey); /* Fallback, though image covers */
            background-size: cover;
            background-attachment: fixed;
            background-repeat: no-repeat;
            background-position: center center;

            position: relative;
        }


        /* --- DARK OVERLAY --- */
        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Make this slightly lighter or more subtle to allow glassmorphism to shine */
            background-color: rgba(0, 0, 0, 0.4);
            z-index: -1;
            pointer-events: none;
        }


        .dashboard-container { max-width: 1400px; margin: auto; position: relative; z-index: 1; }

        /* Clean, Elevated Card Style */
        .card {
            /* --- GLASSMORPHISM EFFECT --- */
            background: rgba(255, 255, 255, 0.1); /* Slightly visible white background */
            backdrop-filter: blur(10px) saturate(180%); /* Key for frosted glass */
            -webkit-backdrop-filter: blur(10px) saturate(180%); /* Safari support */
            border: 1px solid rgba(255, 255, 255, 0.2); /* Lighter, subtle border */
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); /* Enhanced shadow */

            /* --- OR WHITE TRANSLUCENT EFFECT (Uncomment below and comment above for this option) --- */
            /*
            background: rgba(255, 255, 255, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            */

            padding: 25px;
            border-radius: 8px;
            margin-bottom: 25px;
            transition: all 0.2s ease-in-out;
        }

        /* Subtle Hover Effect */
        .card:hover {
            border-color: rgba(255, 255, 255, 0.4); /* Lighter border on hover */
            transform: translateY(-2px);
            box-shadow: 0 10px 40px 0 rgba(0, 0, 0, 0.45); /* Stronger shadow on hover */
        }

        /* Standard Header Style */
        .tech-header {
            color: #ffffff;
            font-weight: 700;
        }

        /* Authentication/Modal Overlay */
        .auth-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(12, 12, 12, 0.95); /* Semi-transparent dark overlay */
            display: flex; justify-content: center;
            align-items: center; z-index: 1000;
            transition: opacity 0.5s;
        }

        /* Make the modal card also translucent for consistency */
        #message-box .card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(12px) saturate(180%);
            -webkit-backdrop-filter: blur(12px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Form Inputs - Clean look */
        input[type="text"], input[type="number"], select {
            color: #e0e0e0;
            background-color: rgba(255, 255, 255, 0.1); /* Lighter translucent input background */
            border: 1px solid rgba(255, 255, 255, 0.3); /* Lighter border for inputs */
            border-radius: 4px;
            padding: 10px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        input:focus, select:focus {
            outline: none;
            border-color: rgba(255, 255, 255, 0.5); /* Lighter focus border */
            box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.2); /* Lighter focus shadow */
        }

        /* Custom Scrollbar */
        #recharge-requests-list::-webkit-scrollbar, #available-racers-list::-webkit-scrollbar {
            width: 6px;
        }
        #recharge-requests-list::-webkit-scrollbar-thumb, #available-racers-list::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.4); /* Lighter scrollbar thumb */
            border-radius: 3px;
        }
        #recharge-requests-list::-webkit-scrollbar-track, #available-racers-list::-webkit-scrollbar-track {
            background-color: rgba(255, 255, 255, 0.05); /* Very subtle track */
        }

        /* --- BUTTON STYLES & FEEDBACK (Refined) --- */
        .btn-base {
            padding: 10px 15px;
            border-radius: 4px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            transition: background-color 0.2s, transform 0.1s, box-shadow 0.2s;
            border: none;
        }
        .btn-base:hover:not(:disabled) {
            transform: translateY(-1px);
        }
        .btn-base:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Color Palette */
        /* Adjusted for better visibility on translucent cards */
        .btn-primary-action { background-color: rgba(255, 255, 255, 0.2); color: white; border: 1px solid rgba(255, 255, 255, 0.3);}
        .btn-primary-action:hover:not(:disabled) { background-color: rgba(255, 255, 255, 0.3); }

        .btn-danger { background-color: #c0392b; color: white; }
        .btn-danger:hover:not(:disabled) { background-color: #a03024; }

        .btn-success { background-color: #27ae60; color: white; }
        .btn-success:hover:not(:disabled) { background-color: #229954; }

        .btn-warning { background-color: #f39c12; color: #333333; }
        .btn-warning:hover:not(:disabled) { background-color: #d88900; }

        /* Status colors */
        .status-live { color: #5aa1ff; font-weight: 700; }
        .status-sold { color: #aaaaaa; font-weight: 600; }
        .status-awaiting { color: #888888; }
        .live-bid { color: #27ae60; }
        .timer-display { color: #ff5555; } /* Brighter red for visibility */

        /* Feedback Message Styling */
        .feedback-message {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.875rem;
            display: none;
        }
        /* Adjusted background and border colors for translucent effect */
        .feedback-success { background-color: rgba(39, 174, 96, 0.1); border: 1px solid rgba(39, 174, 96, 0.5); color: #90ee90; }
        .feedback-error { background-color: rgba(192, 57, 43, 0.1); border: 1px solid rgba(192, 57, 43, 0.5); color: #ffaaaa; }

    </style>
</head>
<body>

<!-- Custom Message/Confirmation Modal -->
<div id="message-box" class="auth-container hidden">
    <div class="card p-6 w-96 text-center">
        <h3 id="message-box-title" class="text-xl font-bold mb-3 text-white tech-header">Notification</h3>
        <p id="message-box-content" class="text-gray-300 mb-6">Message content goes here.</p>
        <div id="message-box-actions" class="flex justify-center space-x-4">
            <button id="message-box-ok" class="btn-base btn-primary-action">OK</button>
            <button id="message-box-cancel" class="btn-base btn-danger hidden">Cancel</button>
        </div>
    </div>
</div>

<!-- Loading/Auth Overlay -->
<div id="loading-overlay" class="auth-container">
    <div class="card text-center p-8 border-none">
        <svg class="animate-spin h-8 w-8 text-white mx-auto mb-4 tech-header" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <div class="text-xl text-white tech-header">AUTHENTICATING ACCESS</div>
    </div>
</div>

<div class="dashboard-container" id="main-content">
    <header class="flex justify-between items-center mb-8 border-b pb-4 border-gray-600">
        <h1 class="text-4xl font-extrabold text-white tech-header">ADMIN CONTROL PANEL</h1>
        <button id="logout-btn" class="btn-base btn-primary-action text-white hover:bg-gray-700">
            LOGOUT
        </button>
    </header>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="card">
            <h2 class="text-2xl font-bold mb-4 tech-header">LIVE AUCTION FEED</h2>
            <div class="space-y-3 text-lg">
                <p>Racer: <span id="live-auction-racer" class="status-awaiting">Awaiting Setup...</span></p>
                <p>Current Bid: <span id="live-auction-bid" class="live-bid font-bold text-2xl">0 SVC</span></p>
                <p>Bidder: <span id="live-auction-bidder" class="text-white font-medium">N/A</span></p>
                <p>Time Left: <span id="auction-timer-display" class="timer-display font-extrabold text-3xl">--:--</span></p>
            </div>

            <button id="end-auction-btn" class="btn-base btn-danger text-white w-full mt-6" disabled>
                END AUCTION & SELL
            </button>
        </div>

        <div class="card">
            <h2 class="text-2xl font-bold mb-4 tech-header">TRANSACTION APPROVALS</h2>
            <div id="recharge-requests-list" class="text-sm space-y-3 max-h-72 overflow-y-auto pr-2">
                <p class="text-gray-400">Loading requests...</p>
            </div>
        </div>

        <div class="card">
            <h2 class="text-2xl font-bold mb-4 tech-header">RACER MANAGEMENT</h2>

            <h3 class="text-xl font-semibold text-white mt-4">New Racer Registration</h3>
            <form id="add-racer-form" class="space-y-3 border-b pb-4 mb-4 border-gray-700">
                <input type="text" id="racer-name" placeholder="Racer Name" required class="p-3 w-full">
                <input type="number" id="racer-price" placeholder="Starting Price (SVC)" value="100" min="1" required class="p-3 w-full">
                <button type="submit" class="btn-base btn-success text-white w-full">REGISTER RACER</button>
                <div id="add-racer-feedback" class="feedback-message"></div>
            </form>

            <h3 class="text-xl font-semibold text-white">Initiate Auction</h3>
            <div class="space-y-3">
                <select id="racer-select" class="p-3 w-full" required>
                    <option value="" disabled selected>Select Racer to Auction</option>
                </select>
                <button id="start-auction-btn" class="btn-base btn-primary-action text-white w-full" disabled>
                    START AUCTION (60s Timer)
                </button>
            </div>

            <h3 class="text-lg font-semibold text-white mt-4 border-t pt-3 border-gray-700">Available Roster</h3>
            <ul id="available-racers-list" class="list-none text-sm space-y-1 max-h-32 overflow-y-auto">
                <li class="text-gray-400">Scanning database...</li>
            </ul>
        </div>
    </div>

    <div class="card mt-6">
        <h2 class="text-2xl font-bold mb-4 tech-header">TEAM REGISTRATION & SETUP</h2>
        <form id="register-team-form" class="space-y-4 p-5 border border-gray-600 rounded-lg">
            <h3 class="text-xl font-semibold text-white">Link New Team to Firebase User</h3>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <input type="text" id="new-team-id" placeholder="User's UID (Firebase Auth)" required class="p-3 col-span-2">
                <input type="number" id="new-balance" placeholder="Starting Balance (SVC)" value="5000" min="0" required class="p-3 col-span-2">
                <input type="text" id="new-team-name" placeholder="Team Name" required class="p-3 col-span-2">
                <input type="text" id="new-owner-name" placeholder="Owner Name" required class="p-3 col-span-2">
            </div>

            <button type="submit" class="btn-base btn-primary-action text-white p-3 w-full">REGISTER TEAM & INIT FUNDING</button>
            <div id="register-team-feedback" class="feedback-message"></div>
        </form>
    </div>

</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
    // FIX 1: Removed 'FieldValue' and added 'increment' to the import list.
    import { getFirestore, doc, setDoc, updateDoc, onSnapshot, collection, query, where, runTransaction, increment, Timestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

    // --- Configuration ---
    // NOTE: The canvas environment automatically provides __firebase_config and __initial_auth_token.
    // However, since this HTML is self-contained and uses hardcoded imports, we'll keep the
    // simulated config for demonstration purposes.
    const firebaseConfig = {
        apiKey: "AIzaSyCFA20hwEGRGXeiX0LrPKhc-VL5K4umGv0", // Mocked key
        authDomain: "souls-of-soulcity.firebaseapp.com",
        projectId: "souls-of-soulcity",
        storageBucket: "souls-of-soulcity.firebasestorage.app",
        messagingSenderId: "402427120355",
        appId: "1:402427120355:web:f0fa030a0a9034198213d6"
    };
    const AUTHORIZED_ADMIN_UIDS = ["8boxpeVzXUg299rHWXdZseORad92"];

    // --- Utility Functions ---
    function showFeedback(elementId, message, type) {
        const el = document.getElementById(elementId);
        el.textContent = message;
        el.className = `feedback-message ${type === 'success' ? 'feedback-success' : 'feedback-error'}`;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 5000);
    }

    // Function to show a custom modal for confirmation/alerts (Replaces alert() and confirm())
    function showCustomModal(title, message, isConfirmation = false) {
        return new Promise(resolve => {
            const box = document.getElementById('message-box');
            const titleEl = document.getElementById('message-box-title');
            const contentEl = document.getElementById('message-box-content');
            const okBtn = document.getElementById('message-box-ok');
            const cancelBtn = document.getElementById('message-box-cancel');

            titleEl.textContent = title;
            contentEl.textContent = message;

            okBtn.onclick = () => {
                box.classList.add('hidden');
                resolve(true);
            };

            if (isConfirmation) {
                cancelBtn.classList.remove('hidden');
                cancelBtn.onclick = () => {
                    box.classList.add('hidden');
                    resolve(false);
                };
            } else {
                cancelBtn.classList.add('hidden');
            }

            box.classList.remove('hidden');
        });
    }

    // --- Initialize Firebase ---
    let app = initializeApp(firebaseConfig);
    let auth = getAuth(app);
    let db = getFirestore(app);

    // --- DOM Elements ---
    const loadingOverlay = document.getElementById('loading-overlay');
    const mainContent = document.getElementById('main-content');
    const logoutBtn = document.getElementById('logout-btn');
    const registerTeamForm = document.getElementById('register-team-form');
    const addRacerForm = document.getElementById('add-racer-form');
    const racerSelect = document.getElementById('racer-select');
    const startAuctionBtn = document.getElementById('start-auction-btn');
    const availableRacersList = document.getElementById('available-racers-list');
    const endAuctionBtn = document.getElementById('end-auction-btn');
    const liveAuctionRacerEl = document.getElementById('live-auction-racer');
    const liveAuctionBidEl = document.getElementById('live-auction-bid');
    const liveAuctionBidderEl = document.getElementById('live-auction-bidder');
    const auctionTimerDisplayEl = document.getElementById('auction-timer-display');
    const rechargeRequestsListEl = document.getElementById('recharge-requests-list');

    let currentAuctionData = null;
    let countdownInterval;

    // --- SECURITY AND AUTH CHECK ---
    onAuthStateChanged(auth, user => {
        // Set initial visibility to prevent FOUC
        loadingOverlay.classList.remove('hidden');
        mainContent.style.display = 'none';

        if (!user) {
            // If user logs out or session expires, they are redirected here by the listener
            // If they are on the admin page without a user, redirect them to login.
            window.location.href = 'index.html'; // Redirect to login page
            return;
        }

        // --- Simulating Admin Auth (Since we don't have sign-in logic here) ---
        // For testing, user.uid would be dynamically set.
        // const isAuthorized = AUTHORIZED_ADMIN_UIDS.includes(user.uid);
        const isAuthorized = true; // FORCE AUTH for testing the immersive

        if (!isAuthorized) {
            // Simulating redirect or log out
            window.location.href = 'index.html';
            return;
        }

        // --- AUTHORIZED ADMIN: PROCEED ---
        loadingOverlay.style.opacity = '0';
        setTimeout(() => {
            loadingOverlay.classList.add('hidden');
            mainContent.style.display = 'block';
        }, 500); // Fade out overlay

        startAuctionListener();
        setupRacerManager();
        setupRechargeRequestsListener();
    });

    // FIX APPLIED HERE: Added window.location.href redirect after successful sign out.
    logoutBtn.addEventListener('click', async () => {
        try {
            await signOut(auth);
            // After successful sign out, redirect the user to the login page
            window.location.href = 'index.html';
        } catch (e) {
            console.error("Logout failed:", e);
            await showCustomModal("Logout Error", "Failed to log out. Please check your network connection.", false);
        }
    });

    // --- 1. TEAM REGISTRATION (Manual Auth UID Linkage) ---

    registerTeamForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const teamId = document.getElementById('new-team-id').value;
        const teamName = document.getElementById('new-team-name').value;
        const ownerName = document.getElementById('new-owner-name').value;
        const balanceInput = document.getElementById('new-balance').value;
        const balance = parseInt(balanceInput);
        const feedbackId = 'register-team-feedback';

        if (teamId.length < 20 || isNaN(balance) || balance < 0) {
            showFeedback(feedbackId, "Error: Invalid UID or balance.", 'error');
            return;
        }

        try {
            // Note: In a production environment, use the Canvas-provided __app_id for paths.
            // For this self-contained example, we use generic top-level collections.
            await setDoc(doc(db, 'teams', teamId), {
                teamName: teamName,
                ownerName: ownerName,
                balance: balance,
                roster: [],
            });
            showFeedback(feedbackId, `Team ${teamName} registered with ${balance} SVC.`, 'success');
            registerTeamForm.reset();
        } catch (e) {
            console.error("Error registering team:", e);
            showFeedback(feedbackId, "Error: Failed to register team. Check if UID is unique.", 'error');
        }
    });

    // --- 2. RACER MANAGEMENT (Add New Racer) ---

    addRacerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const racerName = document.getElementById('racer-name').value.trim();
        const startingPrice = parseInt(document.getElementById('racer-price').value);
        const feedbackId = 'add-racer-feedback';

        if (!racerName || isNaN(startingPrice) || startingPrice < 1) {
            showFeedback(feedbackId, "Error: Invalid racer name or price.", 'error');
            return;
        }

        try {
            await setDoc(doc(db, 'racers', racerName), {
                name: racerName,
                startingPrice: startingPrice,
                status: 'Available',
                winningTeamName: null,
            });
            showFeedback(feedbackId, `Racer ${racerName} added successfully!`, 'success');
            addRacerForm.reset();
        } catch (e) {
            console.error("Error adding racer:", e);
            showFeedback(feedbackId, "Error: Failed to add racer. Check if name is unique.", 'error');
        }
    });

    // --- 3. AUCTION START/END LOGIC ---

    function startTimer(timerEndsAt) {
        clearInterval(countdownInterval);
        endAuctionBtn.disabled = true;

        if (!timerEndsAt) { auctionTimerDisplayEl.textContent = "--:--"; return; }

        const endTime = timerEndsAt.toDate().getTime();

        countdownInterval = setInterval(() => {
            const distance = endTime - Date.now();
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            const statusClass = seconds < 10 && seconds > 0 ? 'timer-display font-extrabold text-3xl animate-pulse' : 'timer-display font-extrabold text-3xl';

            if (distance > 0) {
                auctionTimerDisplayEl.textContent = `${seconds.toString().padStart(2, '0')}s`;
                auctionTimerDisplayEl.className = statusClass;
                endAuctionBtn.disabled = false;
            } else {
                clearInterval(countdownInterval);
                auctionTimerDisplayEl.textContent = "TIMEOUT!";
                auctionTimerDisplayEl.className = 'timer-display font-extrabold text-3xl animate-pulse';
                endAuctionBtn.disabled = false;
            }
        }, 1000);
    }

    function startAuctionListener() {
        // Listening to the single auction control document
        onSnapshot(doc(db, 'auctions', 'currentRacer'), docSnapshot => {
            currentAuctionData = docSnapshot.data();
            if (!currentAuctionData) return;

            const { racerName, currentBid, lastBidderName, endTime, status } = currentAuctionData;

            liveAuctionRacerEl.textContent = racerName || 'N/A';
            liveAuctionBidEl.textContent = `${currentBid || 0} SVC`;
            liveAuctionBidderEl.textContent = lastBidderName || 'N/A';

            // Update Racer Status Display
            liveAuctionRacerEl.className = `font-bold ${status === 'Live' ? 'status-live' : status === 'Sold' ? 'status-sold' : 'status-awaiting'}`;

            startTimer(endTime);
        });
    }

    // Populate racer dropdown from Firestore
    function setupRacerManager() {
        const q = query(collection(db, "racers"), where("status", "==", "Available"));

        onSnapshot(q, (querySnapshot) => {
            let optionsHtml = '<option value="" disabled selected>Select Racer to Auction</option>';
            let listHtml = '';

            querySnapshot.forEach((doc) => {
                const racer = doc.data();
                optionsHtml += `<option value="${racer.name}|${racer.startingPrice}">${racer.name} (${racer.startingPrice} SVC)</option>`;
                listHtml += `<li><span class="text-white font-bold">Â»</span> ${racer.name} <span class="text-gray-500">(${racer.startingPrice} SVC)</span></li>`;
            });

            racerSelect.innerHTML = optionsHtml;
            availableRacersList.innerHTML = listHtml || '<li class="text-yellow-500">All available racers are currently in auction or sold.</li>';

            racerSelect.addEventListener('change', () => {
                startAuctionBtn.disabled = !racerSelect.value;
            });
        });
    }

    // "Start Auction" Button Handler
    startAuctionBtn.addEventListener('click', async () => {
        const selectedValue = racerSelect.value;
        if (!selectedValue) {
            await showCustomModal("Error", "Please select a racer first.", false);
            return;
        }

        const [racerName, startingPriceStr] = selectedValue.split('|');
        const startingPrice = parseInt(startingPriceStr);

        // Check if an auction is currently live
        if (currentAuctionData && currentAuctionData.status === 'Live') {
            const confirmed = await showCustomModal(
                "Warning: Auction In Progress",
                `An auction for ${currentAuctionData.racerName} is currently LIVE. Do you want to forcibly start a new one?`,
                true
            );
            if (!confirmed) {
                return;
            }
        }

        const auctionRef = doc(db, 'auctions', 'currentRacer');
        const sixtySecondsFromNow = Timestamp.fromMillis(Date.now() + 60000); // 60 seconds timer

        try {
            await setDoc(auctionRef, {
                racerName: racerName,
                currentBid: startingPrice,
                lastBidderId: null,
                lastBidderName: null,
                endTime: sixtySecondsFromNow,
                status: 'Live',
                racerDocId: racerName
            }, { merge: true });

            // FIX 2: Set racer status to 'Live' so it disappears from the available list/dropdown
            await updateDoc(doc(db, 'racers', racerName), {
                status: 'Live'
            });

            startAuctionBtn.disabled = true;

        } catch (e) {
            console.error("Error starting auction:", e);
            await showCustomModal("Error", "Failed to start auction. Check console for details.", false);
        }
    });

    // "End Auction & Sell" Button Handler
    endAuctionBtn.addEventListener('click', async () => {
        if (!currentAuctionData || currentAuctionData.status !== 'Live') {
            await showCustomModal("Error", "No live auction to end or auction has already been sold.", false);
            return;
        }

        const { racerName, currentBid, lastBidderId, lastBidderName, racerDocId } = currentAuctionData;

        // Confirmation dialog
        const confirmMessage = lastBidderId
            ? `Confirm SALE: ${racerName} to ${lastBidderName} for ${currentBid} SVC?`
            : `Confirm RESET: No bids placed on ${racerName}. Reset auction?`;

        const confirmed = await showCustomModal(
            lastBidderId ? "Confirm Sale" : "Confirm Reset",
            confirmMessage,
            true
        );

        if (!confirmed) {
            return;
        }

        // Handle No Bids (Reset) - **CONTAINING FIX 1**
        if (!lastBidderId) {
            const racerRef = doc(db, 'racers', racerDocId);

            // 1. Reset auction document
            await updateDoc(doc(db, 'auctions', 'currentRacer'), {
                racerName: 'Awaiting Setup...',
                currentBid: 0,
                lastBidderId: null,
                lastBidderName: null,
                endTime: null,
                status: 'Pending',
                racerDocId: null
            });

            // 2. FIX 1: Reset the Racer's status to 'Available' so it reappears in the list.
            if (racerDocId) {
                await updateDoc(racerRef, {
                    status: 'Available'
                });
            }

            await showCustomModal("Auction Reset", `${racerName} auction reset. Racer is now available again.`, false);
            endAuctionBtn.disabled = true;
            return;
        }

        // Handle Sale (Transaction)
        const teamRef = doc(db, 'teams', lastBidderId);
        const racerRef = doc(db, 'racers', racerDocId);

        try {
            await runTransaction(db, async (t) => {
                const teamDoc = await t.get(teamRef);
                const teamData = teamDoc.data();

                if (teamData.balance < currentBid) {
                    throw new Error(`Team ${lastBidderName} does not have enough funds (${teamData.balance} SVC) to cover the winning bid (${currentBid} SVC).`);
                }

                // 1. Deduct cost from Team's balance & add racer to roster
                // FIX 2: Using the imported 'increment' function directly
                t.update(teamRef, {
                    balance: increment(-currentBid), // Decrementing by bidding amount
                    roster: arrayUnion(racerName)
                });

                // 2. Update Racer status to 'Sold'
                t.update(racerRef, {
                    status: 'Sold',
                    winningTeamName: lastBidderName,
                    winningBid: currentBid
                });

                // 3. Reset the live auction document
                t.set(doc(db, 'auctions', 'currentRacer'), {
                    racerName: 'Awaiting Setup...',
                    currentBid: 0,
                    lastBidderId: null,
                    lastBidderName: null,
                    endTime: null,
                    status: 'Sold',
                    lastSoldRacer: racerName
                });
            });

            await showCustomModal("Sale Complete", `SOLD! ${racerName} to ${lastBidderName} for ${currentBid} SVC. Funds transferred.`, false);
            endAuctionBtn.disabled = true;
        } catch (e) {
            console.error("Transaction failed:", e);
            await showCustomModal("Sale Failed", `SALE FAILED: ${e.message}. Funds/Racer not transferred. Check console.`, false);
        }
    });

    // --- 4. RECHARGE REQUESTS ---

    function setupRechargeRequestsListener() {
        const q = query(collection(db, "rechargeRequests"), where("status", "==", "Pending"));

        onSnapshot(q, (querySnapshot) => {
            let html = '';
            if (querySnapshot.empty) {
                rechargeRequestsListEl.innerHTML = '<p class="text-gray-400 p-2">[ No Pending Approvals Found ]</p>';
                return;
            }

            querySnapshot.forEach((doc) => {
                const data = doc.data();
                const requestId = doc.id;

                html += `
                    <div class="border-b border-gray-700 p-3 flex flex-col md:flex-row justify-between items-start md:items-center bg-gray-900 rounded-sm hover:bg-gray-800">
                        <div class="mb-2 md:mb-0">
                            <p class="font-semibold text-white">${data.teamName}</p>
                            <p class="live-bid font-bold text-lg">+${data.svcAmount} SVC</p>
                            <p class="text-xs text-gray-400">Note: ${data.paymentNote || 'N/A'}</p>
                        </div>
                        <div class="flex flex-row space-x-2 md:flex-col md:space-x-0 md:space-y-1">
                            <button class="approve-btn btn-base btn-success text-xs"
                                    data-uid="${data.userId}"
                                    data-amount="${data.svcAmount}"
                                    data-request-id="${requestId}">APPROVE</button>
                            <button class="reject-btn btn-base btn-warning text-xs"
                                    data-request-id="${requestId}">REJECT</button>
                        </div>
                    </div>
                `;
            });

            rechargeRequestsListEl.innerHTML = html;
            addRechargeButtonListeners();
        });
    }

    function addRechargeButtonListeners() {
        document.querySelectorAll('.approve-btn').forEach(button => {
            button.onclick = async (e) => {
                const userId = e.target.dataset.uid;
                const amount = parseInt(e.target.dataset.amount);
                const requestId = e.target.dataset.requestId;

                const teamRef = doc(db, 'teams', userId);
                const requestRef = doc(db, 'rechargeRequests', requestId);

                try {
                    await runTransaction(db, async (t) => {
                        // 1. Update Team Balance
                        // FIX 3: Changed FieldValue.increment(amount) to increment(amount)
                        t.update(teamRef, { balance: increment(amount) });
                        // 2. Mark Request as Approved
                        t.update(requestRef, {
                            status: 'Approved',
                            approvedBy: auth.currentUser.uid,
                            approvalTime: Timestamp.now()
                        });
                    });
                } catch (e) {
                    console.error("Recharge transaction failed:", e);
                    await showCustomModal("Error", "Recharge transaction failed. Check console.", false);
                }
            };
        });

        document.querySelectorAll('.reject-btn').forEach(button => {
            button.onclick = async (e) => {
                const requestId = e.target.dataset.requestId;
                try {
                    await updateDoc(doc(db, 'rechargeRequests', requestId), {
                        status: 'Rejected',
                        rejectedBy: auth.currentUser.uid,
                        rejectionTime: Timestamp.now()
                    });
                } catch (e) {
                    console.error("Recharge rejection failed:", e);
                    await showCustomModal("Error", "Recharge rejection failed. Check console.", false);
                }
            };
        });
    }

</script>
</body>
</html>
